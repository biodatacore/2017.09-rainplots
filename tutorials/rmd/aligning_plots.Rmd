---
title: "Aligning Plots with Grid Extra"
author: "Mir Henglin"
date: "7/8/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


#### Dendrogram detailed walkthrough

To better understand how this works, lets walk through it step by step. To make what is going on clearer, many layout elements will initially be left visible. We start by creating the empty plot with the same layout and scale as the heatmap.

```{r}
dendro <-
  # empty ggplot with same x and y axis
  ggplot() +
  geom_blank(aes(x = response, y = term), data = longest_x_label_data) + 
  scale_x_discrete(position = 'top') +
  # Match heatmap layoutt
  thm +
  # Remove unneeded text
  theme(axis.text.y = element_blank())

grid.arrange(dendro, es_heatmap_clo, ncol = 2, widths = c(3, 15)) 
```

Having matched the plot layout, the dendrogram will now align with the heatmap.

```{r}

max_dendro <-
  max(abs(c(dendro_dat$y, dendro_dat$yend)))

offset <- max_dendro + 1

dendro <-
  dendro + 
  geom_segment(aes(x = -y+offset, y = x, xend=-yend+offset, yend=xend),
               colour = 'black', 
               data = dendro_dat)

grid.arrange(dendro, es_heatmap_clo, ncol = 2, widths = c(3, 15)) 
```

When we add the dendrogram, we see that it is perfectly aligned to the heatmap labels. However, some of the dendrogram is outside the plotted area to the left. This issue can be rectified through the `expand` argument. The second argument to `expand` controls the space to the left of the plot, and needs to be large enough so that the whole dendrogram is visible. For dendrograms of default thickness, 0.02 is a near-perfect default. For dendrograms with thicker lines, the argument will need to be larger so that the whole dendrogram is plotted. (# Note the offset value calculated above corrects a situation where otherwise the best values to pass to `expand` require a lot of trial and error.)

```{r}

dendro <-
  dendro +
  scale_x_discrete(position = 'top', expand = c(0, 0.02, 0, 0)) 

grid.arrange(dendro, es_heatmap_clo, ncol = 2, widths = c(3, 15)) 
```

To finalize the plot, we make invisible the remaining non-essential layout elements.

```{r}
dendro <-
  dendro +
  theme(panel.grid = element_blank(),
        axis.text = element_text(color = 'white'),
        panel.border = element_rect(fill = NA, color = 'white'))

grid.arrange(dendro, es_heatmap_clo, ncol = 2, widths = c(3, 15)) 
```
